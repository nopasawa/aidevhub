<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบยืมคืนอุปกรณ์</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS (Embedded) -->
    <style>
        /* style.css */

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            padding-top: 80px; /* Space for fixed navbar */
        }

        .navbar {
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #ffffff !important;
        }

        .navbar-nav .nav-link {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.75) !important;
            transition: color 0.3s ease;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: #ffffff !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 8px 15px;
        }

        .content-wrapper {
            margin-top: 30px;
            margin-bottom: 50px;
        }

        .page-section {
            padding: 30px 0;
        }

        h2 {
            color: #0d6efd; /* Primary blue for headings */
            font-size: 2.5rem;
            margin-bottom: 2.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .card {
            border-radius: 15px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: none; /* Remove default border */
            cursor: pointer; /* Make cards clickable */
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .bg-gradient-primary {
            background: linear-gradient(45deg, #0d6efd, #007bff);
        }

        .bg-gradient-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-control.rounded-pill {
            border-radius: 50px !important;
            padding: 0.75rem 1.25rem;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control.rounded-pill:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .form-control.rounded-3 {
            border-radius: 0.5rem !important;
            padding: 0.75rem 1.25rem;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control.rounded-3:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .btn {
            border-radius: 50px; /* Rounded buttons */
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #198754;
            border-color: #198754;
        }
        .btn-success:hover {
            background-color: #157347;
            border-color: #146c43;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #bb2d3b;
            border-color: #b02a37;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
        .btn-info:hover {
            background-color: #31d2f2;
            border-color: #25cff2;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529; /* Dark text for warning */
        }
        .btn-warning:hover {
            background-color: #ffcd39;
            border-color: #ffcb2b;
            transform: translateY(-2px);
        }

        /* Added style for disabled buttons */
        .btn:disabled, .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none; /* No hover effect when disabled */
            box-shadow: none; /* No shadow when disabled */
        }

        .status-badge {
            padding: 0.6em 1em;
            border-radius: 20px; /* More rounded badge */
            font-weight: 600;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-available {
            background-color: #d1e7dd; /* Light green */
            color: #0f5132; /* Dark green */
        }

        .status-borrowed {
            background-color: #f8d7da; /* Light red */
            color: #842029; /* Dark red */
        }

        .table {
            border-radius: 10px;
            overflow: hidden; /* Ensures rounded corners apply to table */
        }

        .table thead th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #e2e6ea;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 1.25rem 1.5rem;
        }

        .modal-title {
            font-weight: 700;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem 1.5rem;
        }

        /* Custom Message Box Styles */
        .message-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050; /* Above Bootstrap modals */
            display: none; /* Hidden by default */
            backdrop-filter: blur(5px); /* Blurred background */
        }

        .message-content {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            animation: fadeInScale 0.3s ease-out;
        }

        .message-content p {
            margin-bottom: 30px;
            font-size: 1.25em;
            color: #343a40;
        }

        .message-content button {
            padding: 12px 35px;
            font-size: 1.1em;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            .navbar-nav .nav-link {
                padding: 10px 15px;
                text-align: center;
            }
            h2 {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }
            .content-wrapper {
                margin-top: 20px;
            }
            h2 {
                font-size: 1.8rem;
                margin-bottom: 2rem;
            }
            .card-body {
                padding: 1rem;
            }
            .table th, .table td {
                font-size: 0.85rem;
                padding: 0.75rem 0.5rem;
            }
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .message-content {
                padding: 25px;
            }
            .message-content p {
                font-size: 1em;
            }
            .message-content button {
                padding: 10px 25px;
                font-size: 1em;
            }
        }

        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 1.1rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            .table-responsive {
                overflow-x: auto; /* Ensure table scrolls on small screens */
            }
            .btn-group-sm > .btn, .btn-sm {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-boxes me-2 fs-4"></i>
                <span class="fw-bold fs-5">ระบบยืมคืนอุปกรณ์</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#" id="nav-home">
                            <i class="fas fa-home me-1"></i>หน้าแรก
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-manage">
                            <i class="fas fa-cogs me-1"></i>จัดการอุปกรณ์
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container content-wrapper">
        <!-- Home Page Section -->
        <section id="home-page" class="page-section">
            <h2 class="mb-5 text-center text-primary fw-bold">
                <i class="fas fa-list-alt me-2"></i>รายการอุปกรณ์ทั้งหมด
            </h2>
            <div id="equipment-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <!-- Equipment cards will be rendered here -->
            </div>
            <div id="no-equipment-message" class="alert alert-info text-center mt-5 p-4 rounded-3 shadow-sm" style="display: none;">
                <i class="fas fa-info-circle me-2"></i> ยังไม่มีอุปกรณ์ในระบบ กรุณาเพิ่มอุปกรณ์ในหน้าจัดการอุปกรณ์
            </div>
        </section>

        <!-- Manage Equipment Page Section -->
        <section id="manage-page" class="page-section" style="display: none;">
            <h2 class="mb-5 text-center text-primary fw-bold">
                <i class="fas fa-tools me-2"></i>จัดการอุปกรณ์
            </h2>

            <!-- Add New Equipment Form -->
            <div class="card shadow-lg mb-5 border-0 rounded-4">
                <div class="card-header bg-gradient-primary text-white rounded-top-4 py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-plus-circle me-2"></i>เพิ่มอุปกรณ์ใหม่</h5>
                </div>
                <div class="card-body p-4">
                    <form id="add-equipment-form">
                        <div class="mb-3">
                            <label for="equipment-name" class="form-label fw-semibold">ชื่ออุปกรณ์ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control rounded-pill" id="equipment-name" placeholder="เช่น โปรเจคเตอร์, กล้อง DSLR" required>
                        </div>
                        <div class="mb-3">
                            <label for="equipment-description" class="form-label fw-semibold">รายละเอียด</label>
                            <textarea class="form-control rounded-3" id="equipment-description" rows="3" placeholder="รายละเอียดเพิ่มเติมเกี่ยวกับอุปกรณ์"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="equipment-quantity" class="form-label fw-semibold">จำนวน <span class="text-danger">*</span></label>
                            <input type="number" class="form-control rounded-pill" id="equipment-quantity" min="1" value="1" required>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill shadow-sm">
                            <i class="fas fa-plus-circle me-2"></i>เพิ่มอุปกรณ์
                        </button>
                    </form>
                </div>
            </div>

            <!-- Equipment Management Table -->
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-gradient-secondary text-white rounded-top-4 py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-boxes me-2"></i>รายการอุปกรณ์ในระบบ</h5>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle">
                            <thead>
                                <tr class="text-nowrap">
                                    <th>#</th>
                                    <th>ชื่ออุปกรณ์</th>
                                    <th>รายละเอียด</th>
                                    <th>จำนวนทั้งหมด</th>
                                    <th>จำนวนที่ว่าง</th>
                                    <th>สถานะ</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="manage-equipment-table-body">
                                <!-- Equipment rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-manage-equipment-message" class="alert alert-info text-center mt-3 p-4 rounded-3 shadow-sm" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i> ยังไม่มีอุปกรณ์ในระบบ
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Edit Equipment Modal -->
    <div class="modal fade" id="editEquipmentModal" tabindex="-1" aria-labelledby="editEquipmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg">
                <div class="modal-header bg-primary text-white rounded-top-4">
                    <h5 class="modal-title fw-bold" id="editEquipmentModalLabel"><i class="fas fa-edit me-2"></i>แก้ไขอุปกรณ์</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="edit-equipment-form">
                        <input type="hidden" id="edit-equipment-id">
                        <div class="mb-3">
                            <label for="edit-equipment-name" class="form-label fw-semibold">ชื่ออุปกรณ์</label>
                            <input type="text" class="form-control rounded-pill" id="edit-equipment-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-equipment-description" class="form-label fw-semibold">รายละเอียด</label>
                            <textarea class="form-control rounded-3" id="edit-equipment-description" rows="3"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="edit-equipment-total-quantity" class="form-label fw-semibold">จำนวนทั้งหมด</label>
                            <input type="number" class="form-control rounded-pill" id="edit-equipment-total-quantity" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm">
                            <i class="fas fa-save me-2"></i>บันทึกการแก้ไข
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lend/Return Modal -->
    <div class="modal fade" id="lendReturnModal" tabindex="-1" aria-labelledby="lendReturnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg">
                <div class="modal-header bg-info text-white rounded-top-4">
                    <h5 class="modal-title fw-bold" id="lendReturnModalLabel"><i class="fas fa-exchange-alt me-2"></i>ยืม/คืนอุปกรณ์</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-2"><strong>อุปกรณ์:</strong> <span id="lend-return-item-name" class="fw-semibold text-primary"></span></p>
                    <p class="mb-4"><strong>สถานะปัจจุบัน:</strong> <span id="lend-return-current-status" class="fw-semibold"></span></p>
                    <div id="lend-form-group" class="mb-3">
                        <label for="borrower-name" class="form-label fw-semibold">ชื่อผู้ยืม</label>
                        <input type="text" class="form-control rounded-pill mb-3" id="borrower-name" placeholder="กรอกชื่อผู้ยืม" required>

                        <label for="borrow-date" class="form-label fw-semibold">วันที่ยืม</label>
                        <input type="date" class="form-control rounded-pill mb-3" id="borrow-date" required>

                        <label for="return-date" class="form-label fw-semibold">วันที่คาดว่าจะคืน</label>
                        <input type="date" class="form-control rounded-pill" id="return-date" required>
                    </div>
                    <div id="return-form-group" class="mb-3" style="display: none;">
                        <p class="text-center fs-5 text-success"><i class="fas fa-question-circle me-2"></i>ต้องการคืนอุปกรณ์นี้?</p>
                    </div>
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
                        <i class="fas fa-times-circle me-2"></i>ปิด
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill" id="confirm-lend-return-btn">
                        <i class="fas fa-check-circle me-2"></i>ยืนยัน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="custom-message-box" class="message-box">
        <div class="message-content rounded-4 shadow-lg">
            <p id="message-text" class="mb-4 fs-5 fw-semibold"></p>
            <button id="message-ok-btn" class="btn btn-primary btn-lg rounded-pill px-5">ตกลง</button>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript (Embedded) -->
    <script>
        // script.js

        // Global variables for elements
        const homePage = document.getElementById('home-page');
        const managePage = document.getElementById('manage-page');
        const navHome = document.getElementById('nav-home');
        const navManage = document.getElementById('nav-manage');
        const equipmentListDiv = document.getElementById('equipment-list');
        const noEquipmentMessage = document.getElementById('no-equipment-message');
        const addEquipmentForm = document.getElementById('add-equipment-form');
        const manageEquipmentTableBody = document.getElementById('manage-equipment-table-body');
        const noManageEquipmentMessage = document.getElementById('no-manage-equipment-message');

        // Edit Modal Elements
        const editEquipmentModal = new bootstrap.Modal(document.getElementById('editEquipmentModal'));
        const editEquipmentForm = document.getElementById('edit-equipment-form');
        const editEquipmentIdInput = document.getElementById('edit-equipment-id');
        const editEquipmentNameInput = document.getElementById('edit-equipment-name');
        const editEquipmentDescriptionInput = document.getElementById('edit-equipment-description');
        const editEquipmentTotalQuantityInput = document.getElementById('edit-equipment-total-quantity');

        // Lend/Return Modal Elements
        const lendReturnModal = new bootstrap.Modal(document.getElementById('lendReturnModal'));
        const lendReturnItemName = document.getElementById('lend-return-item-name');
        const lendReturnCurrentStatus = document.getElementById('lend-return-current-status');
        const lendFormGroup = document.getElementById('lend-form-group');
        const returnFormGroup = document.getElementById('return-form-group');
        const borrowerNameInput = document.getElementById('borrower-name');
        const borrowDateInput = document.getElementById('borrow-date'); // New
        const returnDateInput = document.getElementById('return-date'); // New
        const confirmLendReturnBtn = document.getElementById('confirm-lend-return-btn');

        // Custom Message Box Elements
        const customMessageBox = document.getElementById('custom-message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');

        let equipments = []; // Array to store equipment data

        // Function to show custom message box
        function showMessage(message) {
            messageText.textContent = message;
            customMessageBox.style.display = 'flex';
        }

        // Event listener for custom message box OK button
        messageOkBtn.addEventListener('click', () => {
            customMessageBox.style.display = 'none';
        });


        // Function to load equipments from LocalStorage
        function loadEquipments() {
            const storedEquipments = localStorage.getItem('equipments');
            if (storedEquipments) {
                equipments = JSON.parse(storedEquipments);
            }
        }

        // Function to save equipments to LocalStorage
        function saveEquipments() {
            localStorage.setItem('equipments', JSON.stringify(equipments));
        }

        // Function to generate a unique ID
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Function to switch pages
        function showPage(pageId) {
            homePage.style.display = 'none';
            managePage.style.display = 'none';

            navHome.classList.remove('active');
            navManage.classList.remove('active');

            if (pageId === 'home') {
                homePage.style.display = 'block';
                navHome.classList.add('active');
                renderHomePage();
            } else if (pageId === 'manage') {
                managePage.style.display = 'block';
                navManage.classList.add('active');
                renderManageEquipmentPage();
            }
        }

        // Helper to format date for display
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Render Home Page (Equipment Cards)
        function renderHomePage() {
            equipmentListDiv.innerHTML = ''; // Clear previous cards

            if (equipments.length === 0) {
                noEquipmentMessage.style.display = 'block';
                return;
            } else {
                noEquipmentMessage.style.display = 'none';
            }

            equipments.forEach(equipment => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col';

                const card = document.createElement('div');
                card.className = 'card h-100 shadow-sm border-0 rounded-4';
                card.dataset.id = equipment.id; // Add data-id for click handling
                // Only make the card clickable for lending if there are available items
                if (equipment.quantity - equipment.borrowedCount > 0) {
                    card.onclick = () => openLendReturnModal(equipment.id, 'lend');
                } else {
                    card.style.cursor = 'not-allowed'; // Indicate not clickable for lending
                    card.title = 'ไม่มีอุปกรณ์ว่างให้ยืม';
                }


                const availableQuantity = equipment.quantity - equipment.borrowedCount;
                const statusClass = availableQuantity > 0 ? 'status-available' : 'status-borrowed';
                const statusIcon = availableQuantity > 0 ? 'fas fa-check-circle' : 'fas fa-times-circle';
                const statusText = availableQuantity > 0 ? 'ว่าง' : 'ถูกยืมทั้งหมด';
                const quantityText = `ว่าง: ${availableQuantity} / ทั้งหมด: ${equipment.quantity}`;

                let borrowerInfoHtml = '';
                if (equipment.borrowedCount > 0) {
                    borrowerInfoHtml = `
                        <div class="mt-2 text-muted small">
                            <i class="fas fa-user me-1"></i> ผู้ยืม: ${equipment.borrower || 'ไม่ระบุ'}<br>
                            <i class="fas fa-calendar-alt me-1"></i> ยืม: ${formatDate(equipment.borrowDate)}<br>
                            <i class="fas fa-undo-alt me-1"></i> คืน: ${formatDate(equipment.returnDate)}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-primary fw-bold mb-3">${equipment.name}</h5>
                        <p class="card-text text-muted flex-grow-1">${equipment.description || 'ไม่มีรายละเอียด'}</p>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="status-badge ${statusClass}">
                                <i class="${statusIcon}"></i> ${statusText}
                            </span>
                            <span class="text-secondary fw-semibold">${quantityText}</span>
                        </div>
                        ${borrowerInfoHtml}
                    </div>
                `;
                cardCol.appendChild(card);
                equipmentListDiv.appendChild(cardCol);
            });
        }


        // Render Manage Equipment Page (Table)
        function renderManageEquipmentPage() {
            manageEquipmentTableBody.innerHTML = ''; // Clear previous rows

            if (equipments.length === 0) {
                noManageEquipmentMessage.style.display = 'block';
                return;
            } else {
                noManageEquipmentMessage.style.display = 'none';
            }

            equipments.forEach((equipment, index) => {
                const row = document.createElement('tr');
                const availableQuantity = equipment.quantity - equipment.borrowedCount;
                const statusText = availableQuantity > 0 ? 'ว่าง' : 'ถูกยืมทั้งหมด';
                const statusClass = availableQuantity > 0 ? 'status-available' : 'status-borrowed';
                const statusIcon = availableQuantity > 0 ? 'fas fa-check-circle' : 'fas fa-times-circle';

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="fw-semibold">${equipment.name}</td>
                    <td>${equipment.description || '-'}</td>
                    <td>${equipment.quantity}</td>
                    <td>${availableQuantity}</td>
                    <td><span class="status-badge ${statusClass}"><i class="${statusIcon}"></i> ${statusText}</span></td>
                    <td class="text-nowrap">
                        <button class="btn btn-sm btn-info me-1 lend-return-btn" data-id="${equipment.id}" data-action="lend"
                            ${availableQuantity === 0 ? 'disabled' : ''} title="${availableQuantity === 0 ? 'ไม่มีอุปกรณ์ว่างให้ยืม' : 'ยืมอุปกรณ์'}">
                            <i class="fas fa-hand-holding me-1"></i>ยืม
                        </button>
                        <button class="btn btn-sm btn-warning me-1 lend-return-btn" data-id="${equipment.id}" data-action="return"
                            ${equipment.borrowedCount === 0 ? 'disabled' : ''} title="${equipment.borrowedCount === 0 ? 'ไม่มีอุปกรณ์ถูกยืม' : 'คืนอุปกรณ์'}">
                            <i class="fas fa-undo me-1"></i>คืน
                        </button>
                        <button class="btn btn-sm btn-primary me-1 edit-btn" data-id="${equipment.id}" title="แก้ไขอุปกรณ์">
                            <i class="fas fa-edit me-1"></i>แก้ไข
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${equipment.id}" title="ลบอุปกรณ์">
                            <i class="fas fa-trash-alt me-1"></i>ลบ
                        </button>
                    </td>
                `;
                manageEquipmentTableBody.appendChild(row);
            });

            // Attach event listeners for buttons in the table
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => openEditModal(event.target.dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteEquipment(event.target.dataset.id));
            });
            document.querySelectorAll('.lend-return-btn').forEach(button => {
                button.addEventListener('click', (event) => openLendReturnModal(event.target.dataset.id, event.target.dataset.action));
            });
        }

        // Add New Equipment
        addEquipmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = document.getElementById('equipment-name').value.trim();
            const description = document.getElementById('equipment-description').value.trim();
            const quantity = parseInt(document.getElementById('equipment-quantity').value, 10);

            if (!name || quantity <= 0 || isNaN(quantity)) {
                showMessage('กรุณากรอกชื่ออุปกรณ์และจำนวนที่ถูกต้อง');
                return;
            }

            const newEquipment = {
                id: generateUniqueId(),
                name: name,
                description: description,
                quantity: quantity,
                borrowedCount: 0, // Number of items currently borrowed
                borrower: null, // For simplicity, stores the last borrower for the equipment type
                borrowDate: null, // For simplicity, stores the last borrow date for the equipment type
                returnDate: null, // Expected return date
            };

            equipments.push(newEquipment);
            saveEquipments();
            addEquipmentForm.reset();
            renderManageEquipmentPage();
            showMessage('เพิ่มอุปกรณ์ใหม่เรียบร้อยแล้ว!');
        });

        // Open Edit Modal
        function openEditModal(id) {
            const equipment = equipments.find(eq => eq.id === id);
            if (equipment) {
                editEquipmentIdInput.value = equipment.id;
                editEquipmentNameInput.value = equipment.name;
                editEquipmentDescriptionInput.value = equipment.description;
                editEquipmentTotalQuantityInput.value = equipment.quantity;
                editEquipmentModal.show();
            }
        }

        // Save Edited Equipment
        editEquipmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = editEquipmentIdInput.value;
            const name = editEquipmentNameInput.value.trim();
            const description = editEquipmentDescriptionInput.value.trim();
            const totalQuantity = parseInt(editEquipmentTotalQuantityInput.value, 10);

            if (!name || totalQuantity < 0 || isNaN(totalQuantity)) {
                showMessage('กรุณากรอกชื่ออุปกรณ์และจำนวนที่ถูกต้อง');
                return;
            }

            const equipmentIndex = equipments.findIndex(eq => eq.id === id);
            if (equipmentIndex > -1) {
                const currentEquipment = equipments[equipmentIndex];

                // Prevent reducing total quantity below borrowed count
                if (totalQuantity < currentEquipment.borrowedCount) {
                    showMessage(`ไม่สามารถลดจำนวนทั้งหมดต่ำกว่าจำนวนที่ถูกยืม (${currentEquipment.borrowedCount}) ได้`);
                    return;
                }

                equipments[equipmentIndex] = {
                    ...currentEquipment,
                    name: name,
                    description: description,
                    quantity: totalQuantity,
                };
                saveEquipments();
                editEquipmentModal.hide();
                renderManageEquipmentPage();
                renderHomePage(); // Update home page as well
                showMessage('แก้ไขอุปกรณ์เรียบร้อยแล้ว!');
            }
        });

        // Delete Equipment
        function deleteEquipment(id) {
            // Show custom confirmation dialog
            messageText.innerHTML = `<i class="fas fa-exclamation-triangle text-warning me-2"></i>คุณต้องการลบอุปกรณ์นี้จริงหรือไม่?`;
            customMessageBox.style.display = 'flex';

            // Temporarily store the original handler for OK button
            const originalOkHandler = messageOkBtn.onclick;

            messageOkBtn.onclick = () => {
                customMessageBox.style.display = 'none'; // Hide message box first
                equipments = equipments.filter(eq => eq.id !== id);
                saveEquipments();
                renderManageEquipmentPage();
                renderHomePage(); // Update home page as well
                showMessage('ลบอุปกรณ์เรียบร้อยแล้ว!');
                messageOkBtn.onclick = originalOkHandler; // Restore original handler
            };
            // For a true confirmation, you'd also need a "Cancel" button in the custom message box
            // and a way to handle its click (e.g., hide the message box without deleting).
        }


        // Open Lend/Return Modal
        let currentLendReturnEquipmentId = null;
        let currentLendReturnAction = null;

        function openLendReturnModal(id, action) {
            const equipment = equipments.find(eq => eq.id === id);
            if (equipment) {
                currentLendReturnEquipmentId = id;
                currentLendReturnAction = action;

                lendReturnItemName.textContent = equipment.name;
                const availableQuantity = equipment.quantity - equipment.borrowedCount;
                lendReturnCurrentStatus.textContent = `ว่าง: ${availableQuantity} / ถูกยืม: ${equipment.borrowedCount}`;

                if (action === 'lend') {
                    lendFormGroup.style.display = 'block';
                    returnFormGroup.style.display = 'none';
                    borrowerNameInput.value = equipment.borrower || ''; // Pre-fill if exists
                    
                    const today = new Date().toISOString().split('T')[0];
                    borrowDateInput.value = equipment.borrowDate || today;

                    // Calculate default return date (7 days from borrow date)
                    const defaultReturnDate = new Date(borrowDateInput.value);
                    defaultReturnDate.setDate(defaultReturnDate.getDate() + 7);
                    returnDateInput.value = equipment.returnDate || defaultReturnDate.toISOString().split('T')[0];

                    confirmLendReturnBtn.textContent = 'ยืนยันการยืม';
                    confirmLendReturnBtn.className = 'btn btn-primary rounded-pill';
                    
                    // Disable lend button if no items are available
                    if (availableQuantity === 0) {
                        confirmLendReturnBtn.disabled = true;
                        showMessage('ไม่มีอุปกรณ์ว่างให้ยืม');
                    } else {
                        confirmLendReturnBtn.disabled = false;
                    }

                } else if (action === 'return') {
                    lendFormGroup.style.display = 'none';
                    returnFormGroup.style.display = 'block';
                    confirmLendReturnBtn.textContent = 'ยืนยันการคืน';
                    confirmLendReturnBtn.className = 'btn btn-success rounded-pill';

                    // Disable return button if no items are borrowed
                    if (equipment.borrowedCount === 0) {
                        confirmLendReturnBtn.disabled = true;
                        showMessage('ไม่มีอุปกรณ์ถูกยืมอยู่');
                    } else {
                        confirmLendReturnBtn.disabled = false;
                    }
                }
                lendReturnModal.show();
            }
        }

        // Confirm Lend/Return Action
        confirmLendReturnBtn.addEventListener('click', () => {
            const equipmentIndex = equipments.findIndex(eq => eq.id === currentLendReturnEquipmentId);
            if (equipmentIndex > -1) {
                const equipment = equipments[equipmentIndex];

                if (currentLendReturnAction === 'lend') {
                    const borrower = borrowerNameInput.value.trim();
                    const borrowDate = borrowDateInput.value;
                    const returnDate = returnDateInput.value;

                    if (!borrower || !borrowDate || !returnDate) {
                        showMessage('กรุณากรอกข้อมูลผู้ยืม วันที่ยืม และวันที่คาดว่าจะคืนให้ครบถ้วน');
                        return;
                    }

                    if (equipment.borrowedCount < equipment.quantity) {
                        equipment.borrowedCount++;
                        equipment.borrower = borrower;
                        equipment.borrowDate = borrowDate;
                        equipment.returnDate = returnDate;
                        showMessage(`อุปกรณ์ "${equipment.name}" ถูกยืมโดย "${borrower}" แล้ว`);
                    } else {
                        showMessage(`อุปกรณ์ "${equipment.name}" ไม่ว่างให้ยืมแล้ว`);
                    }
                } else if (currentLendReturnAction === 'return') {
                    if (equipment.borrowedCount > 0) {
                        equipment.borrowedCount--;
                        // If all items of this type are returned, clear borrower info
                        if (equipment.borrowedCount === 0) {
                            equipment.borrower = null;
                            equipment.borrowDate = null;
                            equipment.returnDate = null;
                        }
                        showMessage(`อุปกรณ์ "${equipment.name}" ถูกคืนแล้ว`);
                    } else {
                        showMessage(`อุปกรณ์ "${equipment.name}" ไม่ได้ถูกยืมอยู่`);
                    }
                }
                saveEquipments();
                lendReturnModal.hide();
                renderManageEquipmentPage();
                renderHomePage(); // Update home page as well
            }
        });

        // Navigation Event Listeners
        navHome.addEventListener('click', (event) => {
            event.preventDefault();
            showPage('home');
        });

        navManage.addEventListener('click', (event) => {
            event.preventDefault();
            showPage('manage');
        });

        // Initial load and render
        document.addEventListener('DOMContentLoaded', () => {
            loadEquipments();
            showPage('home'); // Show home page by default
        });
    </script>
</body>
</html>
