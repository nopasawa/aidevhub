<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านค้าออนไลน์</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem; /* Increased padding */
            border-radius: 1rem; /* More rounded */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative; /* For close button positioning */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .modal-content {
                padding: 1.5rem;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Main Application Container -->
    <div class="min-h-screen flex flex-col">
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-2xl font-bold text-gray-900">ร้านค้าออนไลน์</h1>
            <div class="flex items-center space-x-4">
                <!-- Toggle Product Management Button -->
                <button id="toggle-admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    จัดการสินค้า
                </button>
                <!-- Cart Icon -->
                <button id="cart-icon" class="relative bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                    <!-- SVG Cart Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 0a2 2 0 100 4 2 2 0 000-4z" />
                    </svg>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto p-6">
            <!-- Product Management Section (Initially Hidden) -->
            <section id="admin-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">เพิ่มสินค้าใหม่</h2>
                <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า:</label>
                        <input type="text" id="product-name" name="productName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">ราคา (บาท):</label>
                        <input type="number" id="product-price" name="productPrice" required min="0" step="0.01" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="product-quantity-initial" class="block text-sm font-medium text-gray-700 mb-2">จำนวนเริ่มต้น:</label>
                        <input type="number" id="product-quantity-initial" name="productQuantityInitial" required min="0" value="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่:</label>
                        <select id="product-category" name="productCategory" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <input type="text" id="new-category-input" placeholder="เพิ่มหมวดหมู่ใหม่" class="mt-2 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out hidden">
                        <button type="button" id="add-new-category-btn" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out">
                            + เพิ่มหมวดหมู่ใหม่
                        </button>
                    </div>
                    <div class="md:col-span-2">
                        <label for="product-image" class="block text-sm font-medium text-gray-700 mb-2">URL รูปภาพสินค้า:</label>
                        <input type="url" id="product-image" name="productImage" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="https://placehold.co/400x300/E0F2F7/000000?text=Product">
                    </div>
                    <div class="md:col-span-2 text-center">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            เพิ่มสินค้า
                        </button>
                    </div>
                </form>
            </section>

            <!-- Product Listing Section -->
            <section id="product-list-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">สินค้าทั้งหมด</h2>
                <!-- Category Tabs -->
                <div id="category-tabs-container" class="flex flex-wrap justify-center gap-2 mb-6 p-2 bg-gray-50 rounded-lg shadow-inner">
                    <!-- Category tabs will be rendered here by JavaScript -->
                </div>
                <div id="products-container" class="product-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Product cards will be rendered here by JavaScript -->
                </div>
            </section>

            <!-- Shipping Information Section (Initially Hidden) -->
            <section id="shipping-section" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">ข้อมูลการจัดส่ง</h2>
                <form id="shipping-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-นามสกุล:</label>
                        <input type="text" id="customer-name" name="customerName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทรศัพท์:</label>
                        <input type="tel" id="customer-phone" name="customerPhone" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div class="md:col-span-2">
                        <label for="customer-address" class="block text-sm font-medium text-gray-700 mb-2">ที่อยู่:</label>
                        <textarea id="customer-address" name="customerAddress" rows="3" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
                    </div>
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700 mb-2">อีเมล (ไม่บังคับ):</label>
                        <input type="email" id="customer-email" name="customerEmail" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="customer-notes" class="block text-sm font-medium text-gray-700 mb-2">ข้อความเพิ่มเติม (ไม่บังคับ):</label>
                        <input type="text" id="customer-notes" name="customerNotes" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div class="md:col-span-2 text-center">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            ยืนยันการสั่งซื้อ
                        </button>
                    </div>
                </form>
            </section>

            <!-- Order Confirmation Section (Initially Hidden) -->
            <section id="order-confirmation-section" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center text-green-700">คำสั่งซื้อของคุณสำเร็จ!</h2>
                <p class="text-lg text-center mb-4">ขอบคุณสำหรับการสั่งซื้อสินค้าของคุณ</p>
                <p class="text-xl font-semibold text-center mb-6">หมายเลขการสั่งซื้อ: <span id="order-number" class="text-blue-600"></span></p>
                <div class="text-center">
                    <button id="back-to-shop-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        กลับสู่หน้าร้านค้า
                    </button>
                </div>
            </section>
        </main>

        <!-- Cart Modal Overlay -->
        <div id="cart-modal-overlay" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close-button" id="close-cart-modal">&times;</button>
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">ตะกร้าสินค้าของคุณ</h2>
                <div id="cart-items-container" class="space-y-4 mb-6 max-h-96 overflow-y-auto pr-2">
                    <!-- Cart items will be rendered here -->
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="flex justify-between items-center text-lg font-semibold text-gray-800 mb-2">
                        <span>จำนวนสินค้าทั้งหมด:</span>
                        <span id="cart-total-quantity">0 ชิ้น</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold text-gray-900">
                        <span>ราคารวมทั้งหมด:</span>
                        <span id="cart-total-price">0.00 บาท</span>
                    </div>
                </div>
                <div class="flex justify-center mt-8 space-x-4">
                    <button id="confirm-cart-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        ยืนยันการสั่งซื้อ
                    </button>
                    <button id="continue-shopping-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        เลือกสินค้าเพิ่ม
                    </button>
                </div>
            </div>
        </div>

        <!-- Generic Message Modal Overlay (for alerts) -->
        <div id="message-modal-overlay" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 id="message-modal-title" class="text-2xl font-bold text-gray-900 mb-4"></h3>
                <p id="message-modal-text" class="text-lg text-gray-700 mb-6"></p>
                <button id="message-modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ตกลง
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global arrays to store products, categories, and cart items
        let products = [];
        let categories = ['ทั่วไป']; // Default category
        let cart = [];
        let currentView = 'product-list'; // 'product-list', 'admin', 'shipping', 'order-confirmation'
        let currentCategoryFilter = 'ทั้งหมด'; // Default filter for product list

        // DOM Elements
        const productsContainer = document.getElementById('products-container');
        const cartCountSpan = document.getElementById('cart-count');
        const cartIcon = document.getElementById('cart-icon');
        const cartModalOverlay = document.getElementById('cart-modal-overlay');
        const closeCartModalBtn = document.getElementById('close-cart-modal');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalQuantitySpan = document.getElementById('cart-total-quantity');
        const cartTotalPriceSpan = document.getElementById('cart-total-price');
        const confirmCartBtn = document.getElementById('confirm-cart-btn');
        const continueShoppingBtn = document.getElementById('continue-shopping-btn');

        const toggleAdminBtn = document.getElementById('toggle-admin-btn');
        const adminSection = document.getElementById('admin-section');
        const addProductForm = document.getElementById('add-product-form');
        const productCategorySelect = document.getElementById('product-category');
        const newCategoryInput = document.getElementById('new-category-input');
        const addNewCategoryBtn = document.getElementById('add-new-category-btn');

        const productListSection = document.getElementById('product-list-section');
        const categoryTabsContainer = document.getElementById('category-tabs-container');
        const shippingSection = document.getElementById('shipping-section');
        const shippingForm = document.getElementById('shipping-form');
        const orderConfirmationSection = document.getElementById('order-confirmation-section');
        const orderNumberSpan = document.getElementById('order-number');
        const backToShopBtn = document.getElementById('back-to-shop-btn');

        // Generic Message Modal Elements
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalOkBtn = document.getElementById('message-modal-ok-btn');
        let messageModalCallback = null; // Callback function for message modal

        /**
         * Initializes the application by loading data from localStorage
         * and rendering the initial product list.
         */
        function initApp() {
            loadData();
            renderCategorySelectOptions(); // Populate category dropdown in admin
            renderCategoryTabs(); // Render category tabs
            renderProducts(currentCategoryFilter); // Render products based on initial filter
            updateCartIcon();
            showSection(currentView); // Ensure the correct section is shown on load
        }

        /**
         * Saves products, categories, and cart data to localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('cart', JSON.stringify(cart));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        /**
         * Loads products, categories, and cart data from localStorage.
         * Initializes with dummy data if no data is found.
         */
        function loadData() {
            try {
                const storedProducts = localStorage.getItem('products');
                const storedCategories = localStorage.getItem('categories');
                const storedCart = localStorage.getItem('cart');

                if (storedProducts) {
                    products = JSON.parse(storedProducts);
                } else {
                    // Dummy data with categories
                    products = [
                        { id: 'prod1', name: 'เสื้อยืดคอตตอน 100%', price: 299.00, quantity: 50, category: 'เสื้อผ้า', image: 'https://placehold.co/400x300/E0F2F7/000000?text=เสื้อยืด' },
                        { id: 'prod2', name: 'กางเกงยีนส์เดนิม', price: 899.50, quantity: 30, category: 'เสื้อผ้า', image: 'https://placehold.co/400x300/E6F0F6/000000?text=กางเกงยีนส์' },
                        { id: 'prod3', name: 'รองเท้าผ้าใบแฟชั่น', price: 1250.00, quantity: 20, category: 'รองเท้า', image: 'https://placehold.co/400x300/F0F8FF/000000?text=รองเท้าผ้าใบ' },
                        { id: 'prod4', name: 'กระเป๋าสะพายข้าง', price: 450.00, quantity: 40, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/F5F5F5/000000?text=กระเป๋าสะพาย' },
                        { id: 'prod5', name: 'หมวกแก๊ปสไตล์สปอร์ต', price: 199.00, quantity: 60, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/F8F8F8/000000?text=หมวกแก๊ป' },
                        { id: 'prod6', name: 'นาฬิกาข้อมือแบบมินิมอล', price: 799.00, quantity: 25, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/FCFCFC/000000?text=นาฬิกาข้อมือ' },
                        { id: 'prod7', name: 'หนังสือการ์ตูน', price: 150.00, quantity: 100, category: 'หนังสือ', image: 'https://placehold.co/400x300/D1E8E2/000000?text=หนังสือการ์ตูน' }
                    ];
                }

                if (storedCategories) {
                    categories = JSON.parse(storedCategories);
                } else {
                    // Extract unique categories from dummy products if no categories stored
                    const uniqueCategories = new Set(products.map(p => p.category));
                    categories = ['ทั่วไป', ...Array.from(uniqueCategories)].sort();
                }

                if (storedCart) {
                    cart = JSON.parse(storedCart);
                } else {
                    cart = [];
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                // Reset to default if data is corrupted
                products = [
                    { id: 'prod1', name: 'เสื้อยืดคอตตอน 100%', price: 299.00, quantity: 50, category: 'เสื้อผ้า', image: 'https://placehold.co/400x300/E0F2F7/000000?text=เสื้อยืด' },
                    { id: 'prod2', name: 'กางเกงยีนส์เดนิม', price: 899.50, quantity: 30, category: 'เสื้อผ้า', image: 'https://placehold.co/400x300/E6F0F6/000000?text=กางเกงยีนส์' },
                    { id: 'prod3', name: 'รองเท้าผ้าใบแฟชั่น', price: 1250.00, quantity: 20, category: 'รองเท้า', image: 'https://placehold.co/400x300/F0F8FF/000000?text=รองเท้าผ้าใบ' },
                    { id: 'prod4', name: 'กระเป๋าสะพายข้าง', price: 450.00, quantity: 40, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/F5F5F5/000000?text=กระเป๋าสะพาย' },
                    { id: 'prod5', name: 'หมวกแก๊ปสไตล์สปอร์ต', price: 199.00, quantity: 60, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/F8F8F8/000000?text=หมวกแก๊ป' },
                    { id: 'prod6', name: 'นาฬิกาข้อมือแบบมินิมอล', price: 799.00, quantity: 25, category: 'เครื่องประดับ', image: 'https://placehold.co/400x300/FCFCFC/000000?text=นาฬิกาข้อมือ' },
                    { id: 'prod7', name: 'หนังสือการ์ตูน', price: 150.00, quantity: 100, category: 'หนังสือ', image: 'https://placehold.co/400x300/D1E8E2/000000?text=หนังสือการ์ตูน' }
                ];
                categories = ['ทั่วไป', 'เสื้อผ้า', 'รองเท้า', 'เครื่องประดับ', 'หนังสือ'].sort();
                cart = [];
                saveData();
            }
        }

        /**
         * Renders all products as cards in the products container, filtered by category.
         * Attaches event listeners for checkboxes and quantity inputs.
         * @param {string} filterCategory - The category to filter by, or 'ทั้งหมด' for all products.
         */
        function renderProducts(filterCategory) {
            productsContainer.innerHTML = ''; // Clear existing products
            const filteredProducts = filterCategory === 'ทั้งหมด' ? products : products.filter(p => p.category === filterCategory);

            if (filteredProducts.length === 0) {
                productsContainer.innerHTML = `<p class="text-center text-gray-600 col-span-full py-8">ไม่พบสินค้าในหมวดหมู่ "${filterCategory}"</p>`;
                return;
            }

            filteredProducts.forEach(product => {
                // Find if product is already in cart to pre-fill checkbox and quantity
                const cartItem = cart.find(item => item.id === product.id);
                const isChecked = cartItem ? 'checked' : '';
                const quantity = cartItem ? cartItem.quantity : 1; // Quantity in cart
                const availableQuantity = product.quantity; // Available quantity from product list

                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-xl';
                productCard.innerHTML = `
                    <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/E0F2F7/000000?text=No+Image';" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${product.name}</h3>
                        <p class="text-gray-700 text-lg mb-2">ราคา: <span class="font-bold text-blue-600">${product.price.toFixed(2)}</span> บาท</p>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">คงเหลือ: <span class="font-medium">${availableQuantity}</span> ชิ้น</p>
                        <p class="text-gray-500 text-xs mb-2">หมวดหมู่: <span class="font-medium">${product.category}</span></p>
                        <div class="flex items-center justify-between mt-auto">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="checkbox-${product.id}" data-product-id="${product.id}" ${isChecked} class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                                <label for="checkbox-${product.id}" class="text-gray-700 text-sm">เลือก</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="quantity-${product.id}" class="text-gray-700 text-sm">จำนวน:</label>
                                <input type="number" id="quantity-${product.id}" data-product-id="${product.id}" value="${quantity}" min="1" max="${availableQuantity}" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-center text-gray-800 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                            </div>
                        </div>
                    </div>
                `;
                productsContainer.appendChild(productCard);

                // Add event listeners for checkbox and quantity input
                const checkbox = productCard.querySelector(`#checkbox-${product.id}`);
                const quantityInput = productCard.querySelector(`#quantity-${product.id}`);

                checkbox.addEventListener('change', (event) => {
                    let qty = parseInt(quantityInput.value);
                    if (isNaN(qty) || qty < 1) qty = 1; // Default to 1 if invalid
                    if (qty > availableQuantity) qty = availableQuantity; // Cap at available quantity
                    quantityInput.value = qty; // Update input value if adjusted

                    updateCart(product.id, qty, event.target.checked);
                });

                quantityInput.addEventListener('change', (event) => {
                    let newQuantity = parseInt(event.target.value);
                    if (isNaN(newQuantity) || newQuantity < 1) {
                        newQuantity = 1;
                    }
                    if (newQuantity > availableQuantity) {
                        newQuantity = availableQuantity; // Cap at available quantity
                    }
                    event.target.value = newQuantity; // Update input value if adjusted

                    // Only update cart if checkbox is checked
                    if (checkbox.checked) {
                        updateCart(product.id, newQuantity, true);
                    }
                });

                // Initial state check for quantity input
                if (!checkbox.checked) {
                    quantityInput.disabled = true; // Disable quantity if not checked
                }
                checkbox.addEventListener('change', () => {
                    quantityInput.disabled = !checkbox.checked;
                    if (!checkbox.checked) {
                        quantityInput.value = 1; // Reset quantity when unchecked
                    }
                });
            });
        }

        /**
         * Renders the category tabs.
         */
        function renderCategoryTabs() {
            categoryTabsContainer.innerHTML = ''; // Clear existing tabs

            // Add "All" tab
            const allTab = document.createElement('button');
            allTab.textContent = 'ทั้งหมด';
            allTab.dataset.category = 'ทั้งหมด';
            allTab.className = `py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out ${currentCategoryFilter === 'ทั้งหมด' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
            allTab.addEventListener('click', () => {
                currentCategoryFilter = 'ทั้งหมด';
                renderCategoryTabs(); // Re-render tabs to update active state
                renderProducts(currentCategoryFilter);
            });
            categoryTabsContainer.appendChild(allTab);

            // Add other category tabs
            categories.forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.textContent = category;
                tabButton.dataset.category = category;
                tabButton.className = `py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out ${currentCategoryFilter === category ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                tabButton.addEventListener('click', () => {
                    currentCategoryFilter = category;
                    renderCategoryTabs(); // Re-render tabs to update active state
                    renderProducts(currentCategoryFilter);
                });
                categoryTabsContainer.appendChild(tabButton);
            });
        }

        /**
         * Populates the category select dropdown in the admin section.
         */
        function renderCategorySelectOptions() {
            productCategorySelect.innerHTML = ''; // Clear existing options

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'เลือกหมวดหมู่ที่มีอยู่';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            productCategorySelect.appendChild(defaultOption);

            // Add existing categories
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                productCategorySelect.appendChild(option);
            });
        }

        /**
         * Adds or updates a product in the cart.
         * @param {string} productId - The ID of the product.
         * @param {number} quantity - The quantity of the product.
         * @param {boolean} isChecked - True if the product is selected, false otherwise.
         */
        function updateCart(productId, quantity, isChecked) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItemIndex = cart.findIndex(item => item.id === productId);

            if (isChecked) {
                if (existingItemIndex > -1) {
                    // Update quantity of existing item
                    cart[existingItemIndex].quantity = quantity;
                } else {
                    // Add new item to cart
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: quantity
                        // Note: We don't store available quantity in cart, only selected quantity
                    });
                }
            } else {
                // Remove item from cart if unchecked
                if (existingItemIndex > -1) {
                    cart.splice(existingItemIndex, 1);
                }
            }
            saveData();
            updateCartIcon();
        }

        /**
         * Updates the number displayed on the cart icon.
         */
        function updateCartIcon() {
            const totalItemsInCart = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItemsInCart;
        }

        /**
         * Renders the items currently in the cart within the modal.
         * Calculates and displays total quantity and total price.
         */
        function renderCartPopup() {
            cartItemsContainer.innerHTML = ''; // Clear existing items
            let totalQuantity = 0;
            let totalPrice = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-600 py-8">ไม่มีสินค้าในตะกร้า</p>';
                confirmCartBtn.disabled = true; // Disable confirm button if cart is empty
            } else {
                confirmCartBtn.disabled = false; // Enable confirm button
                cart.forEach(item => {
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex items-center bg-gray-50 p-3 rounded-lg shadow-sm';
                    cartItemDiv.innerHTML = `
                        <img src="${item.image}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/E0F2F7/000000?text=No+Image';" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-gray-900">${item.name}</h4>
                            <p class="text-gray-600 text-sm">ราคา: ${item.price.toFixed(2)} บาท x ${item.quantity}</p>
                            <p class="font-bold text-blue-600">รวม: ${(item.price * item.quantity).toFixed(2)} บาท</p>
                        </div>
                        <button data-product-id="${item.id}" class="remove-from-cart-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full text-xs transition duration-300 ease-in-out transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);

                    totalQuantity += item.quantity;
                    totalPrice += item.price * item.quantity;
                });

                // Add event listeners for remove buttons
                document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productIdToRemove = event.currentTarget.dataset.productId;
                        removeItemFromCart(productIdToRemove);
                    });
                });
            }

            cartTotalQuantitySpan.textContent = `${totalQuantity} ชิ้น`;
            cartTotalPriceSpan.textContent = `${totalPrice.toFixed(2)} บาท`;
        }

        /**
         * Removes an item from the cart.
         * @param {string} productId - The ID of the product to remove.
         */
        function removeItemFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveData();
            updateCartIcon();
            renderCartPopup(); // Re-render the cart modal
            renderProducts(currentCategoryFilter); // Re-render product list to uncheck checkbox
        }

        /**
         * Shows the cart modal.
         */
        function openCartPopup() {
            renderCartPopup();
            cartModalOverlay.classList.add('show');
        }

        /**
         * Hides the cart modal.
         */
        function closeCartPopup() {
            cartModalOverlay.classList.remove('show');
        }

        /**
         * Displays a generic message modal.
         * @param {string} title - The title of the message.
         * @param {string} message - The message text.
         * @param {function} callback - Function to call when 'OK' is clicked.
         */
        function showMessageModal(title, message, callback = null) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = message;
            messageModalCallback = callback;
            messageModalOverlay.classList.add('show');
        }

        /**
         * Hides the generic message modal.
         */
        function hideMessageModal() {
            messageModalOverlay.classList.remove('show');
            if (messageModalCallback) {
                messageModalCallback();
                messageModalCallback = null; // Clear callback after execution
            }
        }

        /**
         * Toggles the visibility of different sections of the application.
         * @param {string} sectionName - The name of the section to show ('product-list', 'admin', 'shipping', 'order-confirmation').
         */
        function showSection(sectionName) {
            productListSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            shippingSection.classList.add('hidden');
            orderConfirmationSection.classList.add('hidden');

            switch (sectionName) {
                case 'product-list':
                    productListSection.classList.remove('hidden');
                    currentView = 'product-list';
                    break;
                case 'admin':
                    adminSection.classList.remove('hidden');
                    currentView = 'admin';
                    break;
                case 'shipping':
                    shippingSection.classList.remove('hidden');
                    currentView = 'shipping';
                    break;
                case 'order-confirmation':
                    orderConfirmationSection.classList.remove('hidden');
                    currentView = 'order-confirmation';
                    break;
                default:
                    productListSection.classList.remove('hidden');
                    currentView = 'product-list';
            }
        }

        /**
         * Generates a unique order number.
         * @returns {string} A unique order number.
         */
        function generateOrderNumber() {
            const timestamp = Date.now().toString(36); // Base 36 timestamp
            const random = Math.random().toString(36).substring(2, 7); // Random string
            return `ORD-${timestamp}-${random}`.toUpperCase();
        }

        /**
         * Handles the submission of the shipping form.
         * Saves the order and displays the confirmation.
         * @param {Event} event - The form submission event.
         */
        function handleShippingFormSubmit(event) {
            event.preventDefault();

            // Collect shipping data
            const formData = new FormData(shippingForm);
            const shippingDetails = {};
            for (let [key, value] of formData.entries()) {
                shippingDetails[key] = value;
            }

            // Create order object
            const order = {
                orderId: generateOrderNumber(),
                items: cart,
                shippingDetails: shippingDetails,
                totalQuantity: cart.reduce((sum, item) => sum + item.quantity, 0),
                totalPrice: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                orderDate: new Date().toISOString()
            };

            // Save order to localStorage (append to existing orders)
            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Display order number
            orderNumberSpan.textContent = order.orderId;

            // Clear cart and update UI
            cart = [];
            saveData(); // Save empty cart
            updateCartIcon();
            renderProducts(currentCategoryFilter); // Re-render products to reset checkboxes/quantities

            // Show order confirmation section
            showSection('order-confirmation');
        }

        // --- Event Listeners ---

        // Cart icon click to open modal
        cartIcon.addEventListener('click', openCartPopup);

        // Close cart modal button
        closeCartModalBtn.addEventListener('click', closeCartPopup);

        // Confirm cart button (proceed to shipping)
        confirmCartBtn.addEventListener('click', () => {
            closeCartPopup();
            showSection('shipping');
        });

        // Continue shopping button
        continueShoppingBtn.addEventListener('click', () => {
            closeCartPopup();
            showSection('product-list');
        });

        // Toggle Admin section button
        toggleAdminBtn.addEventListener('click', () => {
            if (adminSection.classList.contains('hidden')) {
                showSection('admin');
            } else {
                showSection('product-list');
            }
        });

        // Toggle new category input visibility
        addNewCategoryBtn.addEventListener('click', () => {
            if (newCategoryInput.classList.contains('hidden')) {
                newCategoryInput.classList.remove('hidden');
                newCategoryInput.focus();
                productCategorySelect.value = ''; // Deselect any existing category
            } else {
                newCategoryInput.classList.add('hidden');
                newCategoryInput.value = ''; // Clear input when hidden
            }
        });

        // Add Product Form submission
        addProductForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const productName = document.getElementById('product-name').value;
            const productPrice = parseFloat(document.getElementById('product-price').value);
            const productQuantityInitial = parseInt(document.getElementById('product-quantity-initial').value);
            const productImage = document.getElementById('product-image').value;
            let productCategory = productCategorySelect.value; // Get selected category

            // If new category input is visible and has a value, use that
            if (!newCategoryInput.classList.contains('hidden') && newCategoryInput.value.trim() !== '') {
                const newCat = newCategoryInput.value.trim();
                if (!categories.includes(newCat)) {
                    categories.push(newCat);
                    categories.sort(); // Keep categories sorted
                    renderCategorySelectOptions(); // Update admin dropdown
                    renderCategoryTabs(); // Update tabs
                }
                productCategory = newCat;
            } else if (!productCategory) {
                // If no existing category selected and no new category entered
                productCategory = 'ทั่วไป'; // Default to 'ทั่วไป'
            }

            if (productName && !isNaN(productPrice) && productPrice >= 0 && !isNaN(productQuantityInitial) && productQuantityInitial >= 0) {
                const newProduct = {
                    id: `prod${Date.now()}`, // Simple unique ID
                    name: productName,
                    price: productPrice,
                    quantity: productQuantityInitial,
                    category: productCategory, // Assign category
                    image: productImage || 'https://placehold.co/400x300/E0F2F7/000000?text=Product' // Default placeholder if no image URL
                };
                products.push(newProduct);
                saveData();
                renderProducts(currentCategoryFilter); // Re-render product list to show new product
                addProductForm.reset(); // Clear form
                newCategoryInput.classList.add('hidden'); // Hide new category input
                newCategoryInput.value = ''; // Clear new category input
                renderCategorySelectOptions(); // Reset category dropdown

                // Show custom message and then navigate back to product list
                showMessageModal('เพิ่มสินค้าสำเร็จ', 'สินค้าถูกเพิ่มเข้าสู่ระบบเรียบร้อยแล้ว', () => {
                    showSection('product-list');
                });
            } else {
                showMessageModal('ข้อมูลไม่ถูกต้อง', 'กรุณากรอกข้อมูลสินค้าให้ถูกต้องและครบถ้วน (ชื่อ, ราคา, จำนวนเริ่มต้น, หมวดหมู่)');
            }
        });

        // Event listener for the generic message modal's OK button
        messageModalOkBtn.addEventListener('click', hideMessageModal);

        // Shipping Form submission
        shippingForm.addEventListener('submit', handleShippingFormSubmit);

        // Back to shop button on order confirmation page
        backToShopBtn.addEventListener('click', () => {
            showSection('product-list');
        });

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
