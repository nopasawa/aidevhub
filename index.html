<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสมาชิกและ Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
        }
        .main-container {
            max-width: 960px; /* Wider container for admin view */
            margin-top: 50px;
            margin-bottom: 50px;
        }
        .form-container, .profile-container, .admin-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .form-toggle {
            cursor: pointer;
            color: #0d6efd;
            text-decoration: underline;
        }
        #loadingSpinner, #loginLoadingSpinner {
            display: none;
        }
        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #dee2e6;
        }
        .table-responsive {
            margin-top: 2rem;
        }
    </style>
</head>
<body>

    <!-- Auth Section (Login/Register) -->
    <div id="auth-section" class="container main-container" style="max-width: 600px;">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Registration Form -->
                <div id="register-form-container" class="form-container">
                    <h2 class="text-center mb-4">สมัครสมาชิก</h2>
                    <form id="registrationForm" novalidate>
                        <div class="mb-3"><label for="regUsername" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" class="form-control" id="regUsername" required></div>
                        <div class="mb-3"><label for="regEmail" class="form-label">อีเมล</label><input type="email" class="form-control" id="regEmail" required></div>
                        <div class="mb-3"><label for="regPassword" class="form-label">รหัสผ่าน</label><input type="password" class="form-control" id="regPassword" required></div>
                        <div class="mb-3"><label for="regFile" class="form-label">รูปโปรไฟล์ หรือ ไฟล์อื่นๆ</label><input class="form-control" type="file" id="regFile" required></div>
                        <div class="d-grid"><button type="submit" class="btn btn-primary btn-lg"><span id="loadingSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> สมัครสมาชิก</button></div>
                    </form>
                    <div id="register-message" class="mt-3"></div>
                    <p class="text-center mt-3">มีบัญชีอยู่แล้ว? <span class="form-toggle" onclick="toggleForms()">เข้าสู่ระบบที่นี่</span></p>
                </div>

                <!-- Login Form -->
                <div id="login-form-container" class="form-container" style="display: none;">
                    <h2 class="text-center mb-4">เข้าสู่ระบบ</h2>
                    <form id="loginForm" novalidate>
                        <div class="mb-3"><label for="loginEmail" class="form-label">อีเมล</label><input type="email" class="form-control" id="loginEmail" required></div>
                        <div class="mb-3"><label for="loginPassword" class="form-label">รหัสผ่าน</label><input type="password" class="form-control" id="loginPassword" required></div>
                        <div class="d-grid"><button type="submit" class="btn btn-success btn-lg"><span id="loginLoadingSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> เข้าสู่ระบบ</button></div>
                    </form>
                    <div id="login-message" class="mt-3"></div>
                    <p class="text-center mt-3">ยังไม่มีบัญชี? <span class="form-toggle" onclick="toggleForms()">สมัครสมาชิกที่นี่</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Section -->
    <div id="profile-section" class="container main-container" style="display: none; max-width: 600px;">
        <div class="profile-container text-center">
            <h2 class="mb-4">ยินดีต้อนรับ!</h2>
            <img id="profile-img" src="https://placehold.co/150x150/EFEFEF/AAAAAA&text=Profile" class="profile-pic mb-3" alt="Profile Picture">
            <h3 id="profile-username"></h3>
            <p id="profile-email" class="text-muted"></p>
            <a id="profile-file-link" href="#" target="_blank" class="btn btn-info mt-2">ดูไฟล์ที่อัปโหลด</a>
            <button class="btn btn-danger mt-4" onclick="logout()">ออกจากระบบ</button>
        </div>
    </div>

    <!-- NEW: Admin Dashboard Section -->
    <div id="admin-section" class="container main-container" style="display: none;">
        <div class="admin-container">
            <div class="d-flex justify-content-between align-items-center">
                <h2>หน้าจัดการสำหรับ Admin</h2>
                <button class="btn btn-danger" onclick="logout()">ออกจากระบบ</button>
            </div>
            <p>คุณเข้าสู่ระบบในฐานะ <strong id="admin-username"></strong> (<span id="admin-email" class="text-muted"></span>)</p>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">วันที่สมัคร</th>
                            <th scope="col">ชื่อผู้ใช้</th>
                            <th scope="col">อีเมล</th>
                            <th scope="col">สิทธิ์</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-table">
                        <tr><td colspan="4" class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // #############################################################################
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5h54rEBdxEbBKIJ1kIw00fjKSlNpGFTJQPihfZiHdQtQAFzxPnJmDXhR4UBsb-8i6/exec';
        // #############################################################################

        const registrationForm = document.getElementById('registrationForm');
        const loginForm = document.getElementById('loginForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loginLoadingSpinner = document.getElementById('loginLoadingSpinner');
        const registerMessage = document.getElementById('register-message');
        const loginMessage = document.getElementById('login-message');

        function toggleForms() {
            const registerContainer = document.getElementById('register-form-container');
            const loginContainer = document.getElementById('login-form-container');
            registerMessage.innerHTML = '';
            loginMessage.innerHTML = '';
            if (registerContainer.style.display === 'none') {
                registerContainer.style.display = 'block';
                loginContainer.style.display = 'none';
            } else {
                registerContainer.style.display = 'none';
                loginContainer.style.display = 'block';
            }
        }

        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                showMessage(registerMessage, 'กรุณาตั้งค่า URL ของ Google Apps Script ในไฟล์ HTML ก่อน', 'danger');
                return;
            }
            loadingSpinner.style.display = 'inline-block';
            registerMessage.innerHTML = '';
            const file = document.getElementById('regFile').files[0];
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!file || !username || !email || !password) {
                showMessage(registerMessage, 'กรุณากรอกข้อมูลให้ครบทุกช่อง', 'danger');
                loadingSpinner.style.display = 'none';
                return;
            }
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64File = reader.result.split(',')[1];
                const formData = { action: "register", username, email, password, fileData: base64File, fileName: file.name, fileType: file.type };
                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(formData), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage(registerMessage, 'สมัครสมาชิกสำเร็จ! กรุณาเข้าสู่ระบบ', 'success');
                        registrationForm.reset();
                        setTimeout(toggleForms, 2000);
                    } else { showMessage(registerMessage, `เกิดข้อผิดพลาด: ${result.message}`, 'danger'); }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage(registerMessage, 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์', 'danger');
                } finally { loadingSpinner.style.display = 'none'; }
            };
            reader.onerror = (error) => {
                console.error('File reading error:', error);
                showMessage(registerMessage, 'เกิดข้อผิดพลาดในการอ่านไฟล์', 'danger');
                loadingSpinner.style.display = 'none';
            };
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                showMessage(loginMessage, 'กรุณาตั้งค่า URL ของ Google Apps Script ในไฟล์ HTML ก่อน', 'danger');
                return;
            }
            loginLoadingSpinner.style.display = 'inline-block';
            loginMessage.innerHTML = '';
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                 showMessage(loginMessage, 'กรุณากรอกอีเมลและรหัสผ่าน', 'danger');
                 loginLoadingSpinner.style.display = 'none';
                 return;
            }

            const url = new URL(GOOGLE_APPS_SCRIPT_URL);
            url.searchParams.append('action', 'login');
            url.searchParams.append('email', email);
            url.searchParams.append('password', password);

            try {
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage(loginMessage, 'เข้าสู่ระบบสำเร็จ!', 'success');
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.data));
                    
                    // *** MODIFIED: Check for admin role ***
                    if (result.data.role === 'admin') {
                        showAdminDashboard(result.data);
                    } else {
                        showProfile(result.data);
                    }
                } else {
                    showMessage(loginMessage, `เกิดข้อผิดพลาด: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage(loginMessage, 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์', 'danger');
            } finally {
                loginLoadingSpinner.style.display = 'none';
            }
        });
        
        function showProfile(userData) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('profile-section').style.display = 'block';

            document.getElementById('profile-username').textContent = userData.username;
            document.getElementById('profile-email').textContent = userData.email;
            
            const profileImg = document.getElementById('profile-img');
            if (userData.profilePictureUrl) {
                const viewableUrl = userData.profilePictureUrl.replace("file/d/", "uc?id=").replace("/view?usp=sharing", "");
                profileImg.src = viewableUrl;
            }
            
            const fileLink = document.getElementById('profile-file-link');
             if (userData.profilePictureUrl) {
                fileLink.href = userData.profilePictureUrl;
                fileLink.style.display = 'inline-block';
            } else {
                fileLink.style.display = 'none';
            }
        }

        // *** NEW FUNCTION: Show Admin Dashboard ***
        async function showAdminDashboard(adminData) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('profile-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';

            document.getElementById('admin-username').textContent = adminData.username;
            document.getElementById('admin-email').textContent = adminData.email;

            // Fetch all user data
            const url = new URL(GOOGLE_APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getAllUsers');
            try {
                const response = await fetch(url);
                const result = await response.json();
                const userTable = document.getElementById('user-list-table');
                userTable.innerHTML = ''; // Clear loading spinner

                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(user => {
                        const row = userTable.insertRow();
                        row.innerHTML = `
                            <td>${user.timestamp}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge ${user.role === 'admin' ? 'bg-success' : 'bg-secondary'}">${user.role}</span></td>
                        `;
                    });
                } else if (result.status === 'success') {
                    userTable.innerHTML = '<tr><td colspan="4" class="text-center">ไม่พบข้อมูลผู้ใช้</td></tr>';
                } else {
                    userTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">เกิดข้อผิดพลาด: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error("Error fetching user list:", error);
                 document.getElementById('user-list-table').innerHTML = `<tr><td colspan="4" class="text-center text-danger">ไม่สามารถโหลดข้อมูลผู้ใช้ได้</td></tr>`;
            }
        }
        
        function logout() {
            sessionStorage.removeItem('loggedInUser');
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('profile-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none'; // Hide admin panel on logout
            loginForm.reset();
            registrationForm.reset();
            if (document.getElementById('login-form-container').style.display === 'none') {
                toggleForms();
            }
        }
        
        window.addEventListener('load', () => {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                // Check role on page load as well
                if (userData.role === 'admin') {
                    showAdminDashboard(userData);
                } else {
                    showProfile(userData);
                }
            }
        });

        function showMessage(element, message, type) {
            element.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }
    </script>
</body>
</html>