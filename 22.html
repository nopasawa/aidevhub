<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปพลิเคชันไรเดอร์ส่งอาหาร (Google Maps)</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Maps API Script -->
    <!-- The 'defer' attribute ensures the script is executed after the page has been parsed. -->
    <!-- The 'callback=initMap' parameter tells the API to run the initMap function once it's loaded. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPJXdUHnTjg_L6x5dmlmbqKMmH-sZCy5M&callback=initMap&libraries=&v=weekly" defer></script>

    <style>
        /* Ensure the map container and html/body have full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map { 
            height: 100%;
            width: 100%;
        }
        /* Custom font for better Thai display */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
            <h1 class="text-xl font-bold">Rider Tracking</h1>
        </div>
        <div id="status-indicator" class="flex items-center space-x-2">
            <span class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
            <span>ออนไลน์</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col lg:flex-row p-4 gap-4" style="height: calc(100% - 72px);">
        
        <!-- Map Container -->
        <div class="lg:w-2/3 w-full h-96 lg:h-full rounded-lg overflow-hidden shadow-lg">
            <div id="map"></div>
        </div>

        <!-- Rider Status Panel -->
        <div class="lg:w-1/3 w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col space-y-4">
            <h2 class="text-2xl font-bold border-b border-gray-200 dark:border-gray-700 pb-2">สถานะไรเดอร์</h2>
            
            <div>
                <p class="font-semibold">ชื่อ:</p>
                <p class="text-blue-500 dark:text-blue-400">สมชาย ใจดี</p>
            </div>
            <div>
                <p class="font-semibold">รหัสไรเดอร์:</p>
                <p>TH-12345</p>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 class="font-bold text-lg mb-2">ตำแหน่งปัจจุบัน</h3>
                <div class="space-y-1 text-sm">
                    <p><strong>ละติจูด:</strong> <span id="lat-display" class="font-mono">...</span></p>
                    <p><strong>ลองจิจูด:</strong> <span id="lon-display" class="font-mono">...</span></p>
                </div>
            </div>
            
            <div id="location-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
              <strong class="font-bold">ผิดพลาด:</strong>
              <span class="block sm:inline" id="error-message">ไม่สามารถเข้าถึงตำแหน่งได้</span>
            </div>

            <div class="flex-grow flex flex-col justify-end">
                <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
                    <p>อัปเดตล่าสุด: <span id="update-time">N/A</span></p>
                    <p>อัปเดตตำแหน่งตามจริงเมื่อมีการเคลื่อนที่</p>
                </div>
                <button id="manual-refresh-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    รีเฟรชตำแหน่ง
                </button>
            </div>
        </div>
    </main>

    <script>
        // --- Global Variables ---
        let map;
        let riderMarker;
        const defaultPosition = { lat: 13.7649, lng: 100.5383 }; // Victory Monument, BKK

        // --- DOM Elements ---
        const latDisplay = document.getElementById('lat-display');
        const lonDisplay = document.getElementById('lon-display');
        const updateTimeDisplay = document.getElementById('update-time');
        const manualRefreshBtn = document.getElementById('manual-refresh-btn');
        const locationErrorDiv = document.getElementById('location-error');
        const errorMessageSpan = document.getElementById('error-message');

        /**
         * This function is called by the Google Maps API script when it has finished loading.
         */
        function initMap() {
            // 1. Create the map instance
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultPosition,
                zoom: 16,
                mapTypeControl: false, // Hides Satellite/Map type buttons
                streetViewControl: false, // Hides Pegman
            });

            // 2. Create a custom icon for the rider marker
            const riderIcon = {
                url: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2M1M2EyYSIgd2lkdGg9IjQ4cHgiIGhlaWdodD0iNDhweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNS41IDNjLTEuMDggMC0yLjA1LjQ5LTIuNjkuMTI5TDEyIDEwLjI5bC0uODEtMS4xN0ExLjAwMSAxLjAwMSAwIDAgMCAxMCA5SDRjLTEuMSAwLTIgLjktMiAydjEuNUMyIDEzLjMzIDIuNjcgMTQgMy41IDE0SDR2NEgydjJoMnYyaDF2LTJoOFY0LjVjMC0uODMtLjY3LTEuNS0xLjUtMS41ek0xMiA3YzEuMSAwIDIgLjkgMiAyaC00Yy4wMS0xLjEgLjg5LTIgMi0yeiIgc3R5bGU9ImZpbGw6IzI1NmNiZDtmaWxsLW9wYWNpdHk6MTtzdHJva2U6I2ZmZmZmZjtzdHJva2Utd2lkdGg6MC41cHgiLz48cGF0aCBkPSJNNiA2YTEuNSAxLjUgMCAxIDAgMC0zIDEuNSAxLjUgMCAwIDAgMCAzem0xMiAwYTEuNSAxLjUgMCAxIDAgMC0zIDEuNSAxLjUgMCAwIDAgMCAzeiIvPjwvc3ZnPg==',
                scaledSize: new google.maps.Size(45, 45),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(22, 22),
            };

            // 3. Create the rider marker and add it to the map
            riderMarker = new google.maps.Marker({
                position: defaultPosition,
                map: map,
                icon: riderIcon,
                title: "ตำแหน่งของฉัน"
            });
            
            // 4. Start tracking the user's real location
            startRealtimeTracking();
        }

        /**
         * Uses the Geolocation API to watch for position changes.
         */
        function startRealtimeTracking() {
            if (!navigator.geolocation) {
                showError("เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง");
                return;
            }

            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // watchPosition updates automatically when the user moves
            navigator.geolocation.watchPosition(updatePosition, handleGeoError, geoOptions);
        }
        
        /**
         * Callback function for successful geolocation fetch.
         * @param {GeolocationPosition} position - The position object from the Geolocation API.
         */
        function updatePosition(position) {
            locationErrorDiv.classList.add('hidden'); // Hide any previous errors
            
            const newPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // Update marker position on the map
            riderMarker.setPosition(newPos);

            // Center the map on the new location
            map.setCenter(newPos);

            // Update the info panel
            latDisplay.textContent = newPos.lat.toFixed(6);
            lonDisplay.textContent = newPos.lng.toFixed(6);
            updateTimeDisplay.textContent = new Date().toLocaleTimeString('th-TH');
        }

        /**
         * Displays an error message in the UI.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessageSpan.textContent = message;
            locationErrorDiv.classList.remove('hidden');
        }

        /**
         * Callback function to handle Geolocation API errors.
         * @param {GeolocationPositionError} error - The error object.
         */
        function handleGeoError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    showError("ผู้ใช้ปฏิเสธการเข้าถึงตำแหน่ง");
                    break;
                case error.POSITION_UNAVAILABLE:
                    showError("ข้อมูลตำแหน่งไม่พร้อมใช้งาน");
                    break;
                case error.TIMEOUT:
                    showError("หมดเวลาในการร้องขอตำแหน่ง");
                    break;
                case error.UNKNOWN_ERROR:
                    showError("เกิดข้อผิดพลาดที่ไม่รู้จัก");
                    break;
            }
        }
        
        // --- Event Listener for Manual Refresh ---
        manualRefreshBtn.addEventListener('click', () => {
            console.log('Manual refresh triggered.');
            if (navigator.geolocation) {
                // Get a single, fresh position update
                navigator.geolocation.getCurrentPosition(updatePosition, handleGeoError);
            }
        });

    </script>
</body>
</html>
